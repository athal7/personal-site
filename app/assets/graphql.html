<!DOCTYPE html>
<html>
  <head>
    <title>GraphQL</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Bitter);

      body { font-family: 'Bitter'; }
      .remark-slide-content {background-color: #f7f7f7;}
      h1, h2, h3 {
        /* font-family: 'Yanone Kaffeesatz'; */
        color: #00557C;
        font-weight: normal;
      }
      h4 {
        margin-top: 30px;
        margin-bottom: 10px;
        font-weight: normal
      }
      h5, h6 {
        margin-top: 0px;
        margin-bottom: 0px;
        font-weight: normal
      }
      a, a:hover, a:visited { color: #007CA6; text-decoration: none;  }
      ol,ul { line-height: 36px; }
      .remark-code { font-size: 13px; width: 100%;}
      .remark-code-line {overflow-wrap: break-word;}
      .remark-code-line-highlighted { background-color: rgba(255,255,0,0.3) }
      img {
        max-width: 100%;
        max-height: 100%;
        display: block;
        margin: 0 auto;
      }
      blockquote {
        display: block;
        background-color: #f0f0f0;
        padding: 10px 20px;
        margin: 0px;
      }
      table {
        border-collapse: collapse;
      }
      table, th, td {
        border: 1px solid black;
      }
      th {
        text-align: center;
      }
      th, td {
        padding: 15px 20px;
        width: 25%;
        vertical-align: top;
      }
      .column {width: 50%;}
      .column-40 {width: 40%;}
      .column-60 {width: 60%;}
      .column-left {float: left;}
      .column-right {float: right;}
      .clear{clear:both}
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle
# GraphQL
### Webservices Guild—May 3, 2018

Andrew Thal, Core Systems

---
## What we'll cover
- What is GraphQL
- Comparison with REST
- Passport Usage—why and how
- Query Structure
- Learnings
- Group Discussion
---
class: center, middle
## What is GraphQL
---
### What is GraphQL

####An API design/definition/schema format
######Similar to (JSON API, RAML, GraphQL, Swagger, and even SOAP)

####"A query language for your API"
######[graphql.org](https://graphql.org)

```graphql
{
  fieldMappings(filters: [{field:"organizationCode", value:"unc-mpa"}]) {
    organization {
      code
      createdBy {
        username
      }
    }
  }
}
```
---
class: center, middle
## Comparison with REST
---
### Comparison with REST (and SOAP)

| Comparison | REST | GraphQL | JSON API |
|-|------|---------|-----|
| Endpoint | per resource | just one | per resource |
| HTTP Verbs | GET, POST, PUT, DELETE | POST | GET, POST, PUT, DELETE |
| Resource(s) returned | Single per request | Join as many as desired | Depends on implementation |
| Response structure/fields | Same for all clients | Client chooses based on request | Client chooses based on request\* |
| Field Types | No contract | Typed schema | No contract |

***
######\* Depending on implementation restrictions
###### NOTE: SOAP more like GraphQL in terms of tradeoffs
---
class: center, middle
## Passport Usage
---
### Passport Usage

**What?**
- Single service to query data from all Salesforces
- Field names are 'standard'
- Maintain field mappings

---
### Passport Usage

**Why GraphQL?**
- Sparse fieldsets (many possible fields)
- Clients often desire related resources
- Clients have vastly different needs—hard to define payloads that work for everyone

---
### Passport Usage

**How?**
- Elixir (performance, esp for subscriptions)
	- Phoenix
  - Absinthe
	- Ecto (maybe Dataloader soon)
	- Apollo

---
class: center, middle
## Query Structure

*Using Passport as examples*
---
### Query Structure
**Fields**

.column.column-left[
```graphql
{
  fieldMappings {
    organizationCode
    fieldName
    apiFieldName
    typeName
  }
}
```
]

.column.column-right[
```json
{
  "data": {
    "fieldMappings": [
      {
        "organizationCode": "unc-mpa",
        "fieldName": "work_experience",
        "apiFieldName": "work_experience__c",
        "typeName": "lead"
      }
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/queries/#fields](https://graphql.org/learn/queries/#fields)
]
---
### Query Structure
**Relationships**

.column.column-left[
```graphql
{
  fieldMappings {
*   organization {
      code
*     createdBy {
        username
      }
    }
  }
}
```
]

.column.column-right[
```json
{
  "data": {
    "fieldMappings": [
      {
*       "organization": {
*         "code": "unc-mpa",
*         "createdBy": {
*           "username": "athal"
*         }
*       }
      }
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/queries/#fields](https://graphql.org/learn/queries/#fields)
]
---
### Query Structure
**Arguments**

.column.column-left[
```graphql
*query myFieldMappingQuery($org: String!) {
* fieldMappings(
*   filter: {organizationCode: $org}
* ) {
    organizationCode
    fieldName
    apiFieldName
    typeName
  }
}
```
###### variables:
```json
{"org": "unc-mpa"}
```
]

.column.column-right[
```json
{
  "data": {
    "fieldMappings": [
      {
        "organizationCode": "unc-mpa",
        "fieldName": "work_experience",
        "apiFieldName": "work_experience__c",
        "typeName": "lead"
      }
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/queries/#arguments](https://graphql.org/learn/queries/#arguments)
]
---
### Query Structure
**Errors**

.column.column-left[
```graphql
{
  fieldMappings {
*   organizationCodes
  }
}
```
]

.column.column-right[
```json
{
  "errors": [
   {
      "message": "Cannot query field \"organizationCodes\" on type \"FieldMapping\". Did you mean \"organization\" or \"organizationCode\"?",
      "locations": [
        {
          "line": 5,
          "column": 0
        }
      ]
    },
  ]
}
```
###### *NOTE: Still a 200 response code*
]
---
### Query Structure
**Advanced Features - Aliases**
.column.column-left[
```graphql
{
* mappings: fieldMappings {
    organizationCode
  }
}
```
]

.column.column-right[
```json
{
  "data": {
*   "mappings": [
      {
        "organizationCode": "unc-mpa"
      }
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/queries/#aliases](https://graphql.org/learn/queries/#aliases)
]
---
### Query Structure
**Advanced Features - Unions / Interfaces**
.column.column-left[
```graphql
{
  salesforceObjects {
    records {
      __typename
*     ...on Account { lastName }
*     ...on Lead { firstName }
    }
  }
}
```]

.column.column-right[
```json
{
  "data": {
    "salesforceObjects": [
      {
        "__typename": "Account",
*       "lastName": "Doe"
      },
      {
        "__typename": "Lead",
*       "firstName": "John"
      },
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/schema/#union-types](https://graphql.org/learn/schema/#union-types)
]
---
### Query Structure
**Advanced Features - Fragments**

.column.column-left[
```graphql
{
  salesforceObjects {
    records {
*     ...accountFragment
*     ...placementFragment
    }
  }
}
*fragment accountFragment on Account {
  lastName
  placements { ...placementFragment }
}
*fragment placementFragment on Placement {
  name
}
```]

.column.column-right[
```json
{
  "data": {
    "salesforceObjects": [
      {
        "lastName": "Doe",
        "placements": [
          {
            "name": "General Hospital"
          }
        ]
      },
      {
       "name": "Grey Sloan Memorial"
      },
      ...
    ]
  }
}
```
]
.clear[
######[https://graphql.org/learn/queries/#fragments](https://graphql.org/learn/queries/#fragments)
]
---
### Query Structure
**Mutations**
.column.column-left[
```graphql
*mutation {
  createFieldMapping(input: {
    organizationCode: "gs-umt",
    fieldName: "work_experience",
    apiFieldName: "work_experience__c",
    typeName: "lead"
  }) {
    apiFieldName
    typeName
  }
}
```
]
.column.column-right[
```json
{
  "data": {
    "createFieldMapping": {
      "apiFieldName": "work_experience__c",
      "typeName": "lead"
    }
  }
}
```
###### *Errors handled the same as with queries*
]
.clear[
######[https://graphql.org/learn/queries/#mutations](https://graphql.org/learn/queries/#mutations)
]
---
### Query Structure
**Subscriptions**
.column.column-left[
```graphql
*subscription {
  salesforceObjectUpdated {
    record {
      ...on Account {
        uid
      }
    }
    changes {
      ...on Account {
        lastModifiedDate
      }
    }
  }
}
```
]

.column.column-right[
```json
{
  "data": {
    "salesforceObjectUpdated": {
      "record": {
        "uid": "0010h00001YETLxAAP"
      },
      "changes": {
        "lastModifiedDate": "2018-04-23 19:23:24",
      }
    }
  }
}
```
###### *over websockets*
]
---
class: center, middle
## Learnings (so far)
---
### Learnings

.column-40.column-left[
**Performance Monitoring**

- NewRelic requires custom instrumentation
- Apollo Engine gives field-level performance and alerting
]

.column-60.column-right[
![Apollo Engine](images/apollo-field-performance.png)
]

---
### Learnings

.column.column-left[
**Caching**
- No cache control headers
- Apollo Engine cache hints

```elixir
object :field_mapping do
  meta(:cache, max_age: 3600, scope: :private)
  ...
end
```
]

.column.column-right[
![Apollo Cache](images/cache.png)
]
---
### Learnings

.column.column-left[
**API Documentation**
- Automatic interactive documentation

```elixir
@desc("A salesforce api field -> standard")
object :field_mapping do
  desc("A salesforce api field -> standard")
  ...
end
```
]

.column.column-right[
![Graphiql](images/graphiql.png)
###### [GraphiQL](https://passport.api.2u.com/graphiql)
]
---
### Learnings

**API Documentation cont.**

- Postman support is just ok :-/, full support expected [soon](https://github.com/postmanlabs/postman-app-support/issues/1669#issuecomment-348693047)
- Insomnia
---

### Learnings

.column.column-left[
**API Versioning**
- Single api endpoint—not versioned
- Can deprecate at a granular query and field level, use apollo to determine no more legacy use

```elixir
object :accounts do
  deprecate("No longer supported")

  field(:uid, deprecate: "please use `sfId`")
  ...
end
```
]

.column.column-right[
![Deprecated](images/deprecated.png)
]
---
### Learnings

**Libraries**

- Great support for servers and for clients in client-side languages
- Weaker support for clients in server-side languages (but it's just a POST request with JSON response)

Examples:
  - Apollo clients (JS, iOS, Android)
  - Absinthe (Elixir)
  - Graphene (Python)
  - GraphQL.js (node)
  - Apollo Server (node)
  - GraphQL (ruby)
  - and more...

---
class: center, middle
## Group Discussion

    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
var slideshow = remark.create({
  navigation: { scroll: false, click: false },
  highlightLines: true,
  highlightStyle: 'github'
});
    </script>
  </body>
</html>
